!function(){function e(){r.readFile("./maps.json",function(e,s){return e?console.log(e):(v=JSON.parse(s),v.loaded=!0,void n())})}function n(){g.length=0,g.push(new a("noob room",v.alpha)),g.push(new a("kinda good room",v.beta)),g.push(new a("pro room",v.delta))}function s(e,n){return e?console.log(e):(this.mapData=JSON.parse(n),this.mapFileRead=!0,void(this.radios=this.mapData.radioStartStates.map(function(e){return e})))}function a(e,n){this.name=e,this.mapInfoRef=n,this.mapData,this.mapFileRead=!1,this.teamAssign=0,r.readFile(n,s.bind(this)),this.numPlayers=0,this.radios=[]}if(!this.System)var o={getenv:function(){}};var t=process.env.PORT||80,i=__dirname+"/index.html",r=require("fs"),d=require("express"),m=require("body-parser"),u=require("http"),l=require("express-session"),c=d(),h=u.Server(c),p=require("socket.io")(h),f=l({secret:o.getenv("secret")||"thisIsNotDeployedCorrectly",resave:!1,saveUninitialized:!0,cookie:{secure:!0}}),k=require("express-socket.io-session");c.use(m.json()),c.use(m.urlencoded({extended:!0})),c.use(f),p.use(k(f));var g=[],v={loaded:!1};e(),a.prototype=Object.create({addPlayer:function(){return this.numPlayers++,this.numPlayers-1},removePlayer:function(e){this.numPlayers--},getRadioTeam:function(){return this.mapFileRead?this.teamAssign++%this.mapData.numTeams:-1}}),c.get("/",function(e,n){n.sendFile(i)}),c.get("/js/compiled.js",function(e,n){n.sendFile(__dirname+"/js/compiled.js")}),c.get("/js/hbsTemplates.js",function(e,n){n.sendFile(__dirname+"/js/hbsTemplates.js")}),c.get("/css/combined.css",function(e,n){n.sendFile(__dirname+"/css/combined.css")}),p.on("connection",function(e){console.log("Socket Connected!");var n=null,s=null;e.handshake.session.userdata||(e.handshake.session.userdata={},e.handshake.session.userdata.name="Guest"),e.handshake.session.roomNumber||(e.handshake.session.roomNumber=null),e.handshake.session.roomIndex||(e.handshake.session.roomIndex=null),e.on("login",function(n){e.handshake.session.userdata=n}),e.on("gameroom",function(a){n=g[a];var o=n.addPlayer();e.handshake.session.roomIndex=o;var t=n.getRadioTeam();e.handshake.session.radioTeam=t,e.handshake.session.roomNumber=a,e.emit("joinedRoom",{roomIndex:o,roomName:n.name,team:t,mapData:g[a].mapData}),e.join(n.name),e.on("roomLoaded",function(){for(var e=0;e<n.radios.length;e++)void 0!==n.radios[e]&&p["in"](n.name).emit("radiosToRoom",{radioIndex:e,time:Date.now(),state:n.radios[e]})}),e.broadcast.to(n.name).emit("newPlayer",e.handshake.session.userdata.name),e.on("disconnect",function(){n&&(e.leave(n.name),n.removePlayer(e.handshake.session.roomIndex)),null!==s&&(clearInterval(s),s=null),n=null,e.handshake.session.roomNumber=null,e.handshake.session.roomIndex=null})}),e.on("radioBroadcast",function(e){e.time=Date.now(),n.radios[e.radioIndex]=e.state,p["in"](n.name).emit("radiosToRoom",e);for(var s=n.radios[0],a=0;a<n.radios.length;a++)if(s!==n.radios[a]){s=null;break}null!==s&&(p["in"](n.name).emit("win",{winningTeam:n.mapData.teamNames[s]}),n.radios=n.mapData.radioStartStates.map(function(e){return e}))}),e.on("disconnect",function(){var n="Unknown User";e.handshake.session.userdata.name&&(n=e.handshake.session.userdata.name),console.log(n+" has disconnected on "+new Date(Date.now()).toLocaleString())})}),c.use(d["static"]("public")),c.use(function(e,n,s){n.status(404).send("Sorry cant find that!")}),c.use(function(e,n,s,a){console.error(e.stack),s.status(500).send("Something broke!")}),h.listen(t,function(){console.log("server started on port "+t)})}();